include "../../private/executables/native/pe.yar"

rule MAL_InnoSetup_Impersonator_Family
{
    meta:
        description = "Detects malware family disguising itself as Inno Setup installers"
        author = "Security Researcher"
        date = "2024-03-04"
        version = "2.0"
        hash_sample = "1f920641735a8e9055093cd352d7e7882c010ecd6527cb68930be5a26af68e59"
        threat_level = "High"
        category = "MALWARE"
        family = "InnoImpersonator"
        mitre_attack = "T1036.001, T1055"
        tlp = "AMBER"
        
    strings:
        // Core identification strings - highest specificity
        $inno_window = "InnoSetupLdrWindow" ascii
        
        // Version strings - moderately specific
        $setup_data = "Inno Setup Setup Data (5.1.10)" ascii
        $setup_msg = "Inno Setup Messages (5.1.11)" ascii
        
        // Error messages - moderately specific
        $error_corrupt = "The setup files are corrupted. Please obtain a new copy of the program." ascii
        $error_block = "Compressed block is corrupted" ascii
        $error_lzma = "lzma: Compressed data is corrupted" ascii
        
        // Distinctive strings - high specificity
        $fake_setup = "MV RegClean 5.5 (Portugal) Setup" ascii
        $author = "By Marcos Velasco" ascii
        
        // Command parameters - moderate specificity
        $param1 = "/SL4" ascii
        $param2 = "/Lang=" ascii
        
        // Admin requirement in manifest - moderate specificity
        $admin = "<requestedExecutionLevel level=\"requireAdministrator\"" ascii
        $code1 = {C6 05 44 A2 40 00 01 C7 45 FC 01} 
        $code2 = {53 56 BE 38 B4 40 00 83 3E 00 75 3A 68 44 06 00 00 6A 00 E8 A8 FF FF FF}
        $code3 = {50 45 00 00 4C 01 08 00 19 5E 42 2A 00 00 00 00 00 00 00 00 E0 00 8F 81}
    condition:
        PE_Structure and
        2 of ($code*) and
        (
            // Basic detection - low confidence
            $inno_window and
            
            // Secondary detection - multiple indicators
            (
                ($setup_data or $setup_msg) and
                (
                    $fake_setup or
                    $author or
                    3 of ($error_*)
                )
            ) or
            
            // Tertiary detection - combination of weaker indicators
            (
                ($fake_setup or $author) and
                3 of ($error_*) and
                ($admin or 1 of ($param*))
            )
        )
}
