include "../../private/executables/native/pe.yar"

rule DDE_Token_Stealer
{
    meta:
        description = "Detects DDE-based security token stealing malware"
        author = "ThreatFlux"
        date = "2025-01-28"
        malware_type = "privilege escalation"
        
    strings:
        // DDE-related strings
        $dde_str1 = "DDEServer" ascii wide
        $dde_str2 = "DDEClient" ascii wide
        $dde_str3 = "MyDDEService" ascii wide
        
        // Function names and debug strings
        $func1 = "TriggerExploitEx" ascii
        $func2 = "xxTriggerExploitEx" ascii
        $func3 = "SetDIBColorTable" ascii
        
        // Token manipulation strings
        $token1 = "Security token to steal: 0x%llx" ascii wide
        $token2 = "Original security token pointer: 0x%llx" ascii wide
        $token3 = "[*]Searching for SYSTEM security token address" ascii wide
        
        // Process-related strings
        $proc1 = "[]Searching for current processes EPROCESS structure" ascii wide
        $proc2 = "tagTHREAD == %llx" ascii wide
        $proc3 = "kapc_stateAddr == %llx" ascii wide
        
        // Exploitation indicators
        $exp1 = "CVE-2019-0803" ascii wide
        $exp2 = "[+]hTriggerWindow" ascii wide
        $exp3 = "[+]SetDIBColorTable OK" ascii wide

    condition:
        PE_Structure and // PE file
        (
            // Require combinations of different string types
            (2 of ($dde_str*)) and
            (2 of ($token*)) and
            (
                (2 of ($func*)) or
                (2 of ($proc*)) or
                (2 of ($exp*))
            )
        )
}
