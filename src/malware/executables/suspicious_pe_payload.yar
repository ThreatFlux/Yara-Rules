import "pe"
include "../../private/executables/native/pe.yar"

rule Suspicious_PE_Payload
{
    meta:
        description = "Detects specific PE executable with static string patterns and structure"
        author = "ThreatFlux"
        date = "2024-01-05" 
        hash = "1540e5cd9028dfe24a83c9d32395f5cf9e8733659411e8228d08c96717f72930"

    strings:
        // DOS header message
        $dos_msg = "This program cannot be run in DOS mode" ascii

        // Rich header markers
        $rich_1 = {52 69 63 68} // "Rich" marker
        
        // Suspicious Base64-like strings 
        $b64_1 = "63ElC4KMGDiCPWZyWT4FHaLXyYo0ihkEikA1ndZGb2t" ascii
        $b64_2 = "rNrFZjt7bQXJmoPak7lpHvxnA8SqM0FT0t" ascii
        
        // PE Section names
        $section_1 = ".text" ascii
        $section_2 = ".rdata" ascii
        $section_3 = ".data" ascii
        $section_4 = ".rsrc" ascii
        $section_5 = ".reloc" ascii

        // Interesting hex patterns from the file
        $hex_1 = { 4d 5a 90 00 03 00 00 00 04 00 00 00 ff ff }
        $hex_2 = { 50 45 00 00 4c 01 05 00 }
        
    condition:
        // Basic PE + size checks
        PE_Structure and
        filesize < 1MB and

        // Required strings/patterns
        $dos_msg and
        $hex_1 and
        $hex_2 and
        
        // Section requirements
        pe.number_of_sections >= 4 and
        all of ($section_*) and
        
        // Additional patterns
        1 of ($rich_*) and
        2 of ($b64_*) and
        
        // Specific section characteristics
        pe.sections[0].name == ".text" and
        pe.sections[0].characteristics & pe.SECTION_MEM_EXECUTE and
        pe.sections[1].name == ".rdata" and
        pe.sections[2].name == ".data"
}
