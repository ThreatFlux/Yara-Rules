include "../../private/executables/native/pe.yar"

rule Suspicious_PowerShell_Commands
{
    meta:
        description = "Detects potentially suspicious PowerShell commands in executables"
        author = "ThreatFlux"
        date = "2024-09-16"
        version = "1.0"
        hash = "N/A"
        file_type = "EXE"
        tlp = "WHITE"
        mitre_attack = "T1059.001"
        family = "Generic.SuspiciousPowerShell"
        scope = "detection, hunting"
        references = "https://attack.mitre.org/techniques/T1059/001/"

    strings:
        $ps_cmd1 = "powershell" nocase wide ascii
        $ps_cmd2 = "pwsh" nocase wide ascii
        
        $susp_arg1 = "-encodedcommand" nocase wide ascii
        $susp_arg2 = "-enc" nocase wide ascii
        $susp_arg3 = "-windowstyle hidden" nocase wide ascii
        $susp_arg4 = "-w hidden" nocase wide ascii
        $susp_arg5 = "-nop" nocase wide ascii
        $susp_arg6 = "-executionpolicy bypass" nocase wide ascii
        
        $susp_cmd1 = "Invoke-Expression" nocase wide ascii
        $susp_cmd2 = "IEX" nocase wide ascii
        $susp_cmd3 = "New-Object Net.WebClient" nocase wide ascii
        $susp_cmd4 = "DownloadString" nocase wide ascii
        $susp_cmd5 = "DownloadFile" nocase wide ascii
        $susp_cmd6 = "Start-Process" nocase wide ascii
        $susp_cmd7 = "ConvertTo-SecureString" nocase wide ascii

    condition:
        PE_Structure and                           // PE file
         (any of ($ps_cmd*)) and
         (
             (2 of ($susp_arg*)) or
             (2 of ($susp_cmd*))
         )
}
