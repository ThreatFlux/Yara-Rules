include "../../private/documents/pdf.yar"

rule DETECT_CommandShell_PDF_Execution
{
    meta:
        description = "Detects Windows Command Shell execution artifacts in PDF files"
        author = "ThreatFlux"
        date = "2024-01-03"
        version = "2.1"
        
        // Classification
        threat_level = "Medium"
        category = "SUSPICIOUS_BEHAVIOR"
        malware_type = "PDF.CommandExecution"
        tlp = "WHITE"
        
        // MITRE ATT&CK Mapping
        mitre_attack = "T1059.003" // Windows Command Shell
        mitre_techniques = "T1204.002" // User Execution: Malicious File
        mitre_tactics = "Execution"
        
        // Detection Details
        detection_name = "PDF.Suspicious.CommandExecution"
        detection_rate = "Medium-High"
        false_positive_rate = "Medium"
        bypass_attempts = "String obfuscation, encoding variations"
        
        // File Characteristics
        file_type = "PDF"
        min_size = "1KB"
        max_size = "10MB"
        
        // References
        ref1 = "https://attack.mitre.org/techniques/T1059/003/"
        ref2 = "https://attack.mitre.org/techniques/T1204/002/"
        
        // Sample Metadata
        sample_hash1 = "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"

    strings:        
        // Command Shell Artifacts
        $cmd1 = "cmd.exe" nocase ascii
        $cmd2 = "cmd /c" nocase ascii
        $cmd3 = "cmd /k" nocase ascii
        $cmd4 = "%comspec%" nocase ascii
        
        // Suspicious PDF Elements
        $suspc1 = "/JavaScript" ascii
        $suspc2 = "/OpenAction" ascii
        $suspc3 = "/Launch" ascii

    condition:
        // File Structure Validation
        PDF_Structure and
        filesize > 1KB and filesize < 10MB and
        
        // Core Detection Logic
        (
            // Command Shell Reference
            any of ($cmd*) and
            
            // Supporting Suspicious Elements
            any of ($suspc*)
        )
}
